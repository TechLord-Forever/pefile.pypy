<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Pefile.pypy - Pefile.py Emulated using Pypy.js</title>

  <!-- Bootstrap core CSS -->
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/style.css" rel="stylesheet">
  <link href="./css/dropzone.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <link href="./css/google-code-prettify/prettify.css" rel="stylesheet">
  <link href="./css/index.css" media="all" type="text/css" rel="stylesheet">
  <link href="./css/jsoneditor.css" rel="stylesheet" type="text/css">
  <script>

  </script>
  <script src="./js/encoding-indexes.js"></script>
  <script src="./js/encoding.js"></script>

  <script src="./js/base64.js"></script>

  <script src="./js/md5.js"></script>
  <script src="./js/sha256.js"></script>

  <script src="./lib/Promise.min.js" type="text/javascript" charset="utf-8" onerror="JavaScript:alert('Error loading file ['+this.src+'] !');"></script>
  <script src="./lib/FunctionPromise.js" type="text/javascript" charset="utf-8" onerror="JavaScript:alert('Error loading file ['+this.src+'] !');"></script>
  <script src="./lib/pypyjs.js" type="text/javascript" charset="utf-8" onerror="JavaScript:alert('Error loading file ['+this.src+'] !');"></script>
  <script src="https://code.jquery.com/jquery-1.11.3.min.js" onerror="JavaScript:alert('Error loading file ['+this.src+'] !');"></script>
  <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js" onerror="JavaScript:alert('Error loading file ['+this.src+'] !');"></script>


  <script src="./js/jsoneditor.js"></script>
  <script src="./js/dropzone.js"></script>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

</head>
<body class="background-white">

  <div class="jumbotron background-gray text-white">

    <!-- TITLE PANEL -->
    <div class="container-fluid">

      <h1>Pefile.pypy</h1>
      <p>PE Binary File Analysis in the browser, <i>without a backend.</i></p>
      <p></p>

    </div>
  </div>

  <div class="container-fluid">
    <div class="row-fluid">

      <!-- UPLOAD PANE -->
      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">

        <h2>Upload File</h2>
        <p>Drag 'n drop your file below, or click to browse.</p>

        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 background-mint">

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            &nbsp;
          </div>

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

            <form id="dropzonediv" action="#" class="background-mint border-thick-dashed dropzone">
              <div class="fallback">
                <input id="files" type="file" name="file" multiple />
              </div>
            </form>

            <div id="previews" class="dropzone-previews"></div>

          </div>

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            &nbsp;
          </div>


        </div>

      </div>

      <!-- RESULTS PANE -->
      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">

        <h2>View Result</h2>
        <p>Your PE Binary File analysis</p>

        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 background-mint">

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            &nbsp;
          </div>

          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

            <pre id="output"><p class="text-center margin-28"><span class="glyphicon glyphicon-time font-three"></span></p></pre>

          </div>


          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            &nbsp;
          </div>

        </div>

      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row-fluid">

      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 padding-bottom-10">

        <h2>About</h2>
        <p>This utility was created and released to the public in January 2017.</p>

        <h2>License</h2>
        <p>Copyright (c) 2016 Cloud Tracer Inc.
        <p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
        <p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
        <p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>

        <h2>Credits</h2>
        <p><strong>Pypyjs</strong><br/>Standard version of <a href="https://github.com/pypyjs/pypyjs" target="_blank" title="Open Pypyjs homepage in a new window">Pypyjs</a>, awesome python in the browser.</p>
        <p><strong>Pefile.py</strong><br/>Modified version of  <a href="https://github.com/erocarrera/pefile" target="_blank" title="Open Pefile.py homepage in a new window">Pefile.py</a> to work with Pypy.js</p>
        <br/><br/><br/><br/><br/><br/><br/><br/><br/>&nbsp;
      </div>

    </div>
  </div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-80552470-1', 'auto');
  ga('send', 'pageview', '/pefile.js/index.html');
    function getArrayBuffer(file) {
      return new Promise(function (resolve, reject) {
          var reader = new FileReader();

          reader.onloadend = function (e) {
              resolve(e.target.result);
          };
          reader.onerror = function (e) {
              reject(e.target.error);
          };
          reader.readAsArrayBuffer(file);
      });
    }
    window.bblob = "";
    Dropzone.autoDiscover = false;
    Dropzone.autoProcessQueue = false;
    var myDropzone = new Dropzone("#dropzonediv");
    Dropzone.prototype.submitRequest = function (xhr, formData, files) {
      console.log("File submitted?")
    };


    myDropzone.on("addedfile", function(file) {
      console.log("file added.")
      if(file){
        console.log("File dropped, count:")
        getArrayBuffer(file).then(function (buffer) {
                try{
                  //var pefile = new Pefile(buffer);
                  document.querySelector("#output").innerHTML = "Please wait while we analyze the file..."
                  var text = buffer;
                  var uint = new Uint8Array(text);
                  var i = uint.length;
                  var binaryString = new Array(i);
                  while (i--)
                  {
                    binaryString[i] = String.fromCharCode(uint[i]);
                  }
                  var data = binaryString.join('');
                  window.bblob = btoa(data);
                  //console.log(pefile.dump_info())
                  //document.querySelector("#output").innerHTML = pefile.dump_info();
                } catch (err){
                  document.querySelector("#output").innerHTML = "Error: File could not be parsed."
                }


            }.bind(this));
      //alert(JSON.stringify(file))
      //readBlob();
    }
  });


    //var xhr = new XMLHttpRequest();
    bin = "";
    uint = "start";
    text = "";
    blob = "";
    bb = "";
    bblob = "";

    var lookup = []
    var revLookup = []
    var Arr = typeof Uint8Array !== 'undefined' ? Uint8Array : Array

    var code = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    for (var i = 0, len = code.length; i < len; ++i) {
      lookup[i] = code[i]
      revLookup[code.charCodeAt(i)] = i
    }

    revLookup['-'.charCodeAt(0)] = 62
    revLookup['_'.charCodeAt(0)] = 63

    function placeHoldersCount (b64) {
      var len = b64.length
      if (len % 4 > 0) {
        throw new Error('Invalid string. Length must be a multiple of 4')
      }

      // the number of equal signs (place holders)
      // if there are two placeholders, than the two characters before it
      // represent one byte
      // if there is only one, then the three characters before it represent 2 bytes
      // this is just a cheap hack to not do indexOf twice
      return b64[len - 2] === '=' ? 2 : b64[len - 1] === '=' ? 1 : 0
    }

    function byteLength (b64) {
      // base64 is 4/3 + up to two characters of the original data
      return b64.length * 3 / 4 - placeHoldersCount(b64)
    }

    function toByteArray (b64) {
      var i, j, l, tmp, placeHolders, arr
      var len = b64.length
      placeHolders = placeHoldersCount(b64)

      arr = new Arr(len * 3 / 4 - placeHolders)

      // if there are placeholders, only get up to the last complete 4 chars
      l = placeHolders > 0 ? len - 4 : len

      var L = 0

      for (i = 0, j = 0; i < l; i += 4, j += 3) {
        tmp = (revLookup[b64.charCodeAt(i)] << 18) | (revLookup[b64.charCodeAt(i + 1)] << 12) | (revLookup[b64.charCodeAt(i + 2)] << 6) | revLookup[b64.charCodeAt(i + 3)]
        arr[L++] = (tmp >> 16) & 0xFF
        arr[L++] = (tmp >> 8) & 0xFF
        arr[L++] = tmp & 0xFF
      }

      if (placeHolders === 2) {
        tmp = (revLookup[b64.charCodeAt(i)] << 2) | (revLookup[b64.charCodeAt(i + 1)] >> 4)
        arr[L++] = tmp & 0xFF
      } else if (placeHolders === 1) {
        tmp = (revLookup[b64.charCodeAt(i)] << 10) | (revLookup[b64.charCodeAt(i + 1)] << 4) | (revLookup[b64.charCodeAt(i + 2)] >> 2)
        arr[L++] = (tmp >> 8) & 0xFF
        arr[L++] = tmp & 0xFF
      }

      return arr
    }

    function tripletToBase64 (num) {
      return lookup[num >> 18 & 0x3F] + lookup[num >> 12 & 0x3F] + lookup[num >> 6 & 0x3F] + lookup[num & 0x3F]
    }

    function encodeChunk (uint8, start, end) {
      var tmp
      var output = []
      for (var i = start; i < end; i += 3) {
        tmp = (uint8[i] << 16) + (uint8[i + 1] << 8) + (uint8[i + 2])
        output.push(tripletToBase64(tmp))
      }
      return output.join('')
    }

    function fromByteArray (uint8) {
      var tmp
      var len = uint8.length
      var extraBytes = len % 3 // if we have 1 byte left, pad 2 bytes
      var output = ''
      var parts = []
      var maxChunkLength = 16383 // must be multiple of 3

      // go through the array every three bytes, we'll deal with trailing stuff later
      for (var i = 0, len2 = len - extraBytes; i < len2; i += maxChunkLength) {
        parts.push(encodeChunk(uint8, i, (i + maxChunkLength) > len2 ? len2 : (i + maxChunkLength)))
      }

      // pad the end with zeros, but make sure to not forget the extra bytes
      if (extraBytes === 1) {
        tmp = uint8[len - 1]
        output += lookup[tmp >> 2]
        output += lookup[(tmp << 4) & 0x3F]
        output += '=='
      } else if (extraBytes === 2) {
        tmp = (uint8[len - 2] << 8) + (uint8[len - 1])
        output += lookup[tmp >> 10]
        output += lookup[(tmp >> 4) & 0x3F]
        output += lookup[(tmp << 2) & 0x3F]
        output += '='
      }

      parts.push(output)

      return parts.join('')
    }

    var Base64Binary = {
    	_keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    	/* will return a  Uint8Array type */
    	decodeArrayBuffer: function(input) {
    		var bytes = (input.length/4) * 3;
    		var ab = new ArrayBuffer(bytes);
    		this.decode(input, ab);

    		return ab;
    	},

    	removePaddingChars: function(input){
    		var lkey = this._keyStr.indexOf(input.charAt(input.length - 1));
    		if(lkey == 64){
    			return input.substring(0,input.length - 1);
    		}
    		return input;
    	},

    	decode: function (input, arrayBuffer) {
    		//get last chars to see if are valid
    		input = this.removePaddingChars(input);
    		input = this.removePaddingChars(input);

    		var bytes = parseInt((input.length / 4) * 3, 10);

    		var uarray;
    		var chr1, chr2, chr3;
    		var enc1, enc2, enc3, enc4;
    		var i = 0;
    		var j = 0;

    		if (arrayBuffer)
    			uarray = new Uint8Array(arrayBuffer);
    		else
    			uarray = new Uint8Array(bytes);

    		input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

    		for (i=0; i<bytes; i+=3) {
    			//get the 3 octects in 4 ascii chars
    			enc1 = this._keyStr.indexOf(input.charAt(j++));
    			enc2 = this._keyStr.indexOf(input.charAt(j++));
    			enc3 = this._keyStr.indexOf(input.charAt(j++));
    			enc4 = this._keyStr.indexOf(input.charAt(j++));

    			chr1 = (enc1 << 2) | (enc2 >> 4);
    			chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
    			chr3 = ((enc3 & 3) << 6) | enc4;

    			uarray[i] = chr1;
    			if (enc3 != 64) uarray[i+1] = chr2;
    			if (enc4 != 64) uarray[i+2] = chr3;
    		}

    		return uarray;
    	}
    }


    function base64_to_uint8array(s) {
      var byteChars = atob(s);
      var l = byteChars.length;
      var byteNumbers = new Array(l);
      for (var i = 0; i < l; i++) {
        byteNumbers[i] = byteChars.charCodeAt(i);
      }
      return new Uint8Array(byteNumbers);
    }

    function UTF8ArrToStr(aBytes) {
      var sView = "";
      for (var nPart, nLen = aBytes.length, nIdx = 0; nIdx < nLen; nIdx++) {
        nPart = aBytes[nIdx];
        sView += String.fromCharCode(
          nPart > 251 && nPart < 254 && nIdx + 5 < nLen ? /* six bytes */
            /* (nPart - 252 << 30) may be not so safe in ECMAScript! So...: */
            (nPart - 252) * 1073741824 + (aBytes[++nIdx] - 128 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
          : nPart > 247 && nPart < 252 && nIdx + 4 < nLen ? /* five bytes */
            (nPart - 248 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
          : nPart > 239 && nPart < 248 && nIdx + 3 < nLen ? /* four bytes */
            (nPart - 240 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
          : nPart > 223 && nPart < 240 && nIdx + 2 < nLen ? /* three bytes */
            (nPart - 224 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
          : nPart > 191 && nPart < 224 && nIdx + 1 < nLen ? /* two bytes */
            (nPart - 192 << 6) + aBytes[++nIdx] - 128
          : /* nPart < 127 ? */ /* one byte */
            nPart
        );
      }
      return sView;
    }

    var md5 = SparkMD5.ArrayBuffer.hash;

    function md5dosum(thing){
      console.log(thing);
      var thishash = md5(new Uint8Array(thing));
      console.log("Normal buffer: " + thishash );
      //console.log("To buffer: " + md5(uarray.buffer));
    //  console.log("Array buffer: " + md5(new TextDecoder("ascii").decode(Base64Binary.decode(buffer))));
      //console.log("Array buffer: " + md5(Base64Binary.decodeArrayBuffer(thing)));
      /*
      console.log("after buffer: " + md5(binaryStringToBuffer(newbuff)));
      var thishash = md5(buffer);
      console.log("without buffer: " + thishash)
      var blobbers = new Blob([binaryStringToBuffer(buffer)], {type: 'application/octet-stream'});
      console.log("blobbers buffer: " + md5(blobbers))
      console.log("bytes buffer: " + md5(binaryStringToBuffer(buffer).toString()))
      */
      return thishash;
    }

    function DoHashFunction(thing, type){
      //console.log(thing);
      if(type == "md5") var thishash = md5(new Uint8Array(thing));
      if(type == "sha2") var thishash = sha256(new Uint8Array(thing));
      if(type == "ssdeep") var thishash = sha256(new Uint8Array(thing));
      return thishash;
    }

    function print_python_hash(string){
      console.log("pythong hash: " +string)
    }

    function Uint8ArrayToBString(uint){
      //int = new Int8Array(text);
      var i = uint.length;
      var binaryString = new Array(i);
      while (i--)
      {
        binaryString[i] = String.fromCharCode(uint[i]);
      }
      var data = binaryString.join('');
      return data;
    }

    function ParseFile(){
      xhr.open("GET",url  , true);
      xhr.responseType = "arraybuffer";
      xhr.addEventListener('readystatechange', function(e) {
        if( this.readyState === 4 ) {
          text = xhr.response
          uint = new Uint8Array(text);
          var i = uint.length;
          var binaryString = new Array(i);
          while (i--)
          {
            binaryString[i] = String.fromCharCode(uint[i]);
          }
          var data = binaryString.join('');
          bblob = btoa(data);
        }
      });
      xhr.send();
    }

    try {
        jQuery(document);
    } catch (e) {
        alert("Error, jQuery JS not loaded!\n Original error was:" + e);
    }
    function console_exec(code) {
        console.log("exec: '" + code + "'");
        pypyjs.exec(code).then(function() {
            console.log("OK");
            pypyjs.stdout("\n>>> ");
        }, function (err) {
            // err is an instance of PyPyJS.Error
            console.log("ERROR: "+err.name+": "+err.message+"!)");
            pypyjs.stderr(err.trace); // the human-readable traceback, as a string
        });
    }
    $(document).ready(function() {
        out = $("#output");
        try{
        pypyjs.stdout = pypyjs.stderr = function(data) {
            out.append(data);
        }
        pypyjs.stdout.reset = pypyjs.stderr.reset = function(data) {
            out.empty();
        }
        pypyjs.totalMemory = 268435456;
        pypyjs.stdout("Loading Dependencies please wait...");
        var pseudo_status = setInterval(function(){ pypyjs.stdout("."); }, 500);
        pypyjs.ready().then(function() {
            clearInterval(pseudo_status);
            pypyjs.stdout.reset();
            pypyjs.stdout('Loading Complete! Please drag a file into the drop zone.');
            //console_exec("from __future__ import division;from __future__ import print_function;import encodings.utf_16_le;import os;import struct;import sys;import codecs;import time;import math;import re;import string;import array;import ordlookup;import sys;import js;import base64;from collections import Counter; from hashlib import sha1; from hashlib import sha256; from hashlib import sha512; from hashlib import md5; import js;import base64;import pefile;")
            //console_exec("import js;import base64;import pefile; import encodings.utf_16_le;");
            //pypyjs.execfile('./pe.py');
            window.newbblob = "";
            var file_status = setInterval(function(){
              console.log("Checking for file");
              if(bblob != "" && newbblob != "" ) location.reload();
              window.newbblob = JSON.parse(JSON.stringify(bblob))

              if(bblob != ""){
                document.querySelector("#output").innerHTML = "Parsing file please wait.\r\n";
                try{
                  pypyjs.execfile('./pe.py').then(function(){
                  //pypyjs.exec("t=js.eval('bblob');b=base64.b64decode(str(t));pe=pefile.PE(data=b);print(pe.dump_info());").then(function(){
                    bblob = "";
                    newbblob = "";
                  });
                } catch(e){
                  document.querySelector("#output").innerHTML = "Error: File could not be parsed.";
                  bblob = "";
                  newbblob = "";
                }

              }
            }, 500);

            //pypyjs.execfile('./pe.py');
            window.inputs="";
        });
      } catch (e){
        console.log("error throw")
      }
    });

  </script>

</html>
